<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Gachapon</title>
  <style>body{font-family:sans-serif;padding:20px;background:#071025;color:#e6eef6}a{color:#7c3aed}table{width:100%;border-collapse:collapse;margin-top:12px}th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}button{padding:6px 10px;border-radius:6px;border:0;background:#ef4444;color:white;cursor:pointer}</style>
</head>
<body>
  <h1>管理ダッシュボード</h1>
  <p><a href="/">アプリに戻る</a> · <a href="/login.html">ログアウト/再ログイン</a></p>
  <div>
    <button id="btn-refresh">一覧更新</button>
  <button id="btn-create" onclick="location.href='/?create=1'">新しいガチャ作成（エディタへ）</button>
  </div>

  <table id="gacha-table">
    <thead><tr><th>ID</th><th>タイトル</th><th>カテゴリ</th><th>作成日</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="msg" style="margin-top:12px;color:#fca5a5"></div>

  <script>
    const API = (location.hostname === 'localhost') ? 'http://localhost:4000/api' : '/api';
    function getToken(){ return localStorage.getItem('accessToken'); }
    async function fetchWithAuth(url, opts={}){
      opts.headers = opts.headers || {};
      const t = getToken(); if(t) opts.headers['Authorization'] = 'Bearer ' + t;
      return fetch(url, opts);
    }

    async function loadList(){
      document.getElementById('msg').textContent = '';
      try{
        const r = await fetchWithAuth(API + '/gachas');
        if(!r.ok){ document.getElementById('msg').textContent = '一覧の取得に失敗しました'; return; }
        const list = await r.json();
        const tbody = document.querySelector('#gacha-table tbody'); tbody.innerHTML = '';
        list.forEach(g => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${g.id}</td><td>${g.title}</td><td>${g.category||''}</td><td>${g.created_at||''}</td><td><button data-id='${g.id}' class='del'>削除</button></td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.del').forEach(b=>b.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          if(!confirm('Delete gacha '+id+' ?')) return;
          const dr = await fetchWithAuth(API + '/gachas/' + id, { method: 'DELETE' });
          if(dr.ok){ loadList(); } else { document.getElementById('msg').textContent = '削除に失敗しました'; }
        }));
      }catch(err){ console.error(err); document.getElementById('msg').textContent = 'Network error'; }
    }

    document.getElementById('btn-refresh').addEventListener('click', ()=>loadList());
    // initial
    loadList();
  </script>
</body>
</html>
